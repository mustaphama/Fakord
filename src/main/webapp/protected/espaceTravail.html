<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Canal</title>
</head>
<body>
<h1>Canaux</h1>
<p>Liste des canaux publics</p>
<ul id="canal-list"></ul>

<div id="canal-form" style="display:none;">
    <h3>Cr√©er un canal</h3>
    <input type="text" id="canal-nom" placeholder="Nom du canal">
    <select id="canal-statut">
        <option value="Public">Public</option>
        <option value="Priv√©">Priv√©</option>
    </select>
    <button onclick="createCanal()">Cr√©er</button>
</div>

<script>

    const espaceNom = new URLSearchParams(window.location.search).get("nom");
    let isAdmin = false;

    async function fetchCanaux() {
        const res = await fetch(`canal?espace=${encodeURIComponent(espaceNom)}`);
        const data = await res.json();

        const list = document.getElementById("canal-list");
        list.innerHTML = "";

        if (data.success) {
            data.canaux.forEach(canal => {
                const li = document.createElement("li");
                const lien = document.createElement("a");
                lien.href = `conversationCanal.html?canal=${encodeURIComponent(canal.nom)}`;
                lien.textContent = `${canal.nom} (${canal.statut})`;
                li.appendChild(lien);
                list.appendChild(li);
                if (isAdmin) {
                    const btn = document.createElement("button");
                    btn.textContent = "üóëÔ∏è Supprimer";
                    btn.className = "btn-message";
                    btn.onclick = () => deleteCanal(canal.nom);
                    li.appendChild(btn);
                }
            });
        }
    }
    function deleteCanal(nom) {
        if (!confirm(`Voulez-vous vraiment supprimer le canal "${nom}" ?`)) return;

        fetch(`canal?nom=${encodeURIComponent(nom)}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Canal supprim√© !");
                    location.reload();
                } else {
                    alert("Erreur : " + data.message);
                }
            })
            .catch(error => console.error('Erreur lors de la suppression :', error));
    }
    async function checkAdmin() {
        const res = await fetch(`espaceTravail/`);
        const data = await res.json();
        if (data.success) {
            const espace = data.espaces.find(e => e.nom === espaceNom);
            if (espace && espace.isAdmin) {
                isAdmin = true;
                document.getElementById("canal-form").style.display = "block";
            }
        }
    }

    async function createCanal() {
        const nom = document.getElementById("canal-nom").value;
        const statut = document.getElementById("canal-statut").value;

        const res = await fetch("canal/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                nom: nom,
                statut: statut,
                nomEspace: espaceNom
            })
        });

        const data = await res.json();
        alert(data.message || "Cr√©ation effectu√©e");
        fetchCanaux();
    }

    checkAdmin();
    fetchCanaux();
</script>
</body>
</html>
